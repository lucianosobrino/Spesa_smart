<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Grocery Chef Pro</title>
    
    <link rel="icon" type="image/png" href="SpesaSmart.png?v=1">
    <link rel="apple-touch-icon" href="SpesaSmart.png?v=1">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #f8fafc; -webkit-font-smoothing: antialiased; overscroll-behavior-y: contain; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .main-container { padding-bottom: 160px; }
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(20px); }
        .has-tooltip { position: relative; }
        .tooltip { visibility: hidden; position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; white-space: nowrap; z-index: 100; opacity: 0; transition: opacity 0.2s; }
        .has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .mini-loader { width: 16px; height: 16px; border: 2px solid #ffffff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        .error-shake { animation: shake 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const App = () => {
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('chef_api_key') || '');
            const [items, setItems] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('chef_items') || '[]');
                } catch {
                    return [];
                }
            });
            const [recipes, setRecipes] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('chef_recipes') || '[]');
                } catch {
                    return [];
                }
            });
            const [history, setHistory] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('chef_history') || '[]');
                } catch {
                    return [];
                }
            });

            const [autoSave, setAutoSave] = useState(() => {
                const saved = localStorage.getItem('chef_autosave');
                return saved === null ? true : saved !== 'false';
            });
            const [showSocial, setShowSocial] = useState(() => {
                const saved = localStorage.getItem('chef_show_social');
                return saved === null ? true : saved !== 'false';
            });
            const [aiEnabled, setAiEnabled] = useState(() => {
                const saved = localStorage.getItem('chef_ai_enabled');
                return saved === null ? true : saved !== 'false';
            });

            const [showSettings, setShowSettings] = useState(!apiKey);
            const [showHistory, setShowHistory] = useState(false);
            const [showConfirmReset, setShowConfirmReset] = useState(false);
            const [showConfirmClearBought, setShowConfirmClearBought] = useState(false);
            const [errorModal, setErrorModal] = useState({ show: false, title: '', message: '' });
            const [hideBought, setHideBought] = useState(false); 
            const [collapsedCats, setCollapsedCats] = useState({});
            const [isLoading, setIsLoading] = useState(false);
            const [textInput, setTextInput] = useState('');
            
            const [pendingCategoryItems, setPendingCategoryItems] = useState([]);
            const [categoryWizardOpen, setCategoryWizardOpen] = useState(false);
            const [currentPendingIndex, setCurrentPendingIndex] = useState(0);
            const [isRecording, setIsRecording] = useState(false);
            const recognitionRef = useRef(null);

            const CATEGORY_OPTIONS = [
                "Frutta e Verdura", "Gastronomia", "Macelleria", "Pescheria", "Latticini",
                "Surgelati", "Forno", "Dispensa", "Bevande",
                "Detersivi", "Igiene", "Altro"
            ];

            const [categoryMap, setCategoryMap] = useState(() => {
                try {
                    return JSON.parse(localStorage.getItem('chef_category_map') || '{}');
                } catch {
                    return {};
                }
            });

            // Per la gestione del drag & drop
            const onDragStartItem = (e, itemId) => {
              e.dataTransfer.setData('text/plain', String(itemId));
            };
            
            const onDropCategory = (e, targetCat) => {
              const idStr = e.dataTransfer.getData('text/plain');
              if (!idStr) return;
              const id = Number(idStr);
            
              setItems(prev =>
                prev.map(i =>
                  i.id === id ? { ...i, category: targetCat } : i
                )
              );
            
              // aggiorna anche la mappa per il nome di questo item
              setItems(prev => {
                const found = prev.find(i => i.id === id);
                if (!found) return prev;
                const norm = (found.name || '').toLowerCase();
                setCategoryMap(prevMap => ({
                  ...prevMap,
                  [norm]: targetCat
                }));
                return prev;
              });
            };
            
            const onDragOverCategory = (e) => {
              e.preventDefault();
            };


            // Inizializzazione riconoscimento vocale
            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    const recognition = new SpeechRecognition();
                    recognition.lang = 'it-IT';
                    recognition.continuous = true;
                    recognition.interimResults = false;
                    recognition.onresult = (event) => {
                        const text = event.results[event.results.length - 1][0].transcript;
                        setTextInput(prev => (prev ? prev + ' ' : '') + text.trim());
                    };
                    recognition.onerror = () => setIsRecording(false);
                    recognition.onend = () => setIsRecording(false);
                    recognitionRef.current = recognition;
                }
            }, []);

            // Auto-save lista, ricette, cronologia, aiEnabled
            useEffect(() => {
                if (autoSave) {
                    localStorage.setItem('chef_items', JSON.stringify(items));
                    localStorage.setItem('chef_recipes', JSON.stringify(recipes));
                    localStorage.setItem('chef_history', JSON.stringify(history));
                    localStorage.setItem('chef_ai_enabled', aiEnabled ? 'true' : 'false');
                    localStorage.setItem('chef_category_map', JSON.stringify(categoryMap));                   
                }
            }, [items, recipes, history, autoSave, aiEnabled, categoryMap]);

            // Salvataggio impostazioni indipendenti dalla lista
            useEffect(() => {
                localStorage.setItem('chef_autosave', autoSave ? 'true' : 'false');
                localStorage.setItem('chef_show_social', showSocial ? 'true' : 'false');
            }, [autoSave, showSocial]);

            const splitToItems = (raw) => {
                if (!raw) return [];
            
                // minuscolo e punteggiatura → virgole
                let text = raw.toLowerCase().replace(/[.,;:!?()\[\]]+/g, ',');
            
                // parole di rumore (senza "e")
                //const noise = [
               //     /\baggiungi\b/gi,
               //     /\bancora\b/gi,
               //     /\bdi\b/gi,
              //      /\bun\b/gi,
              //      /\buna\b/gi
              //  ];
               // noise.forEach(re => text = text.replace(re, ','));
            
                // normalizza: sostituisci " e " con " , "
                text = text.replace(/\se\s/gi, ' , ');
            
                // split su virgole e spazi multipli
                return text
                    .split(/[,]+/)
                    .map(s => s.trim())
                    .filter(s => s.length > 0);
            };

            const processWithAI = async (input) => {
                const query = input.trim();
                if (!query || isLoading) return;

                // Aggiungo alla cronologia la richiesta (sempre, anche senza IA)
                setHistory(prev => [
                    ...prev,
                    { id: Date.now() + Math.random(), ts: Date.now(), text: query }
                ]);

                // Modalità senza IA: usa mappa categorie + wizard
                //if (!aiEnabled) {
                //    const names = splitToItems(query);
                //    if (names.length > 0) {
                //        const newItems = [];
                //        const toAsk = [];

                //        names.forEach(n => {
                //            const norm = n.toLowerCase();
                //            const savedCat = categoryMap[norm];
                //            if (savedCat) {
                //                newItems.push({
                //                    id: Date.now() + Math.random(),
                //                    name: n,
                //                    category: savedCat,
                //                    bought: false
                //                });
                //            } else {
                //                toAsk.push(n);
                //            }
                //        });

                //        if (newItems.length > 0) {
                //            setItems(prev => [...prev, ...newItems]);
                //        }

                //        if (toAsk.length > 0) {
                //            setPendingCategoryItems(toAsk);
                //            setCurrentPendingIndex(0);
                //            setCategoryWizardOpen(true);
                //        }
                //    }
                //    setTextInput('');
                //    return;
                //}

                if (!aiEnabled) {
                  const names = splitToItems(query);
                  if (names.length > 0) {
                    const newItems = [];
                    const toAsk = [];
                
                    names.forEach(n => {
                      const norm = n.toLowerCase();
                      const savedCat = categoryMap[norm];
                      if (savedCat) {
                        // categoria già nota: aggiungo subito
                        newItems.push({
                          id: Date.now() + Math.random(),
                          name: n,
                          category: savedCat,
                          bought: false
                        });
                      } else {
                        // categoria sconosciuta: chiedo all’utente
                        toAsk.push(n);
                      }
                    });
                
                    if (newItems.length > 0) {
                      setItems(prev => [...prev, ...newItems]);
                    }
                
                    if (toAsk.length > 0) {
                      setPendingCategoryItems(toAsk);
                      setCurrentPendingIndex(0);
                      setCategoryWizardOpen(true);
                    }
                  }
                  setTextInput('');
                  return;
                }


                // Modalità con IA
                if (!apiKey) {
                    setShowSettings(true);
                    return;
                }

                setIsLoading(true);

                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [
                                    { role: "user", parts: [{ text: `Input: "${query}"` }] }
                                ],
                                systemInstruction: {
                                    role: "system",
                                    parts: [{
                                        text: `Restituisci SOLO JSON: {"add":[{"n":"nome prodotto","c":"categoria"}], "remove":[...]}`
                                    }]
                                },
                                generationConfig: {
                                    responseMimeType: "application/json",
                                    temperature: 0.1
                                }
                            })
                        }
                    );

                    const data = await response.json();
                    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) {
                        throw new Error("Risposta IA non valida");
                    }

                    const result = JSON.parse(text);

                    let newList = [...items];

                    if (Array.isArray(result.add)) {
                        result.add.forEach(a => {
                            if (!a?.n) return;
                            const cat = a.c || "Altro";
                            newList.push({
                                id: Date.now() + Math.random(),
                                name: a.n,
                                category: cat,
                                bought: false
                            });

                            // Aggiorno anche la categoryMap per gli item aggiunti da IA
                            const norm = String(a.n).toLowerCase();
                            setCategoryMap(prev => {
                                const updated = { ...prev, [norm]: cat };
                                localStorage.setItem('chef_category_map', JSON.stringify(updated));
                                return updated;
                            });
                        });
                    }

                    if (Array.isArray(result.remove) && result.remove.length > 0) {
                        const toRemoveNames = result.remove.map(r => String(r).toLowerCase());
                        newList = newList.filter(
                            it => !toRemoveNames.includes(String(it.name).toLowerCase())
                        );
                    }

                    setItems(newList);
                    setTextInput('');
                } catch (e) {
                    setErrorModal({
                        show: true,
                        title: "Errore",
                        message: "Impossibile contattare l'IA o risposta non valida. Controlla la tua API Key."
                    });
                } finally {
                    setIsLoading(false);
                }
            };

            // const addPendingItemWithCategory = (cat) => {
            //    const name = pendingCategoryItems[currentPendingIndex];
            //    const chosenCat = cat || "Altro";

            //    setItems(prev => [
            //        ...prev,
            //        { id: Date.now() + Math.random(), name, category: chosenCat, bought: false }
            //    ]);

            //    // Aggiorno la mappa categorie e la salvo
            //    setCategoryMap(prev => {
            //        const norm = name.toLowerCase();
            //        const updated = { ...prev, [norm]: chosenCat };
            //        localStorage.setItem('chef_category_map', JSON.stringify(updated));
            //        return updated;
            //    });

            //    if (currentPendingIndex + 1 >= pendingCategoryItems.length) {
            //        setCategoryWizardOpen(false);
            //        setPendingCategoryItems([]);
            //        setCurrentPendingIndex(0);
            //    } else {
            //        setCurrentPendingIndex(idx => idx + 1);
            //    }
            //};

             const addPendingItemWithCategory = (cat) => {
                      const name = pendingCategoryItems[currentPendingIndex];
                      const chosenCat = cat || "Altro";
                      const norm = name.toLowerCase();
                    
                      // aggiorna lista
                      setItems(prev => [
                        ...prev,
                        { id: Date.now() + Math.random(), name, category: chosenCat, bought: false }
                      ]);
                    
                      // aggiorna mappa attribuzioni
                      setCategoryMap(prev => ({
                        ...prev,
                        [norm]: chosenCat
                      }));
                    
                      if (currentPendingIndex + 1 >= pendingCategoryItems.length) {
                        setCategoryWizardOpen(false);
                        setPendingCategoryItems([]);
                        setCurrentPendingIndex(0);
                      } else {
                        setCurrentPendingIndex(idx => idx + 1);
                      }
                    };


            const groupedItems = useMemo(() => {
                const filtered = hideBought ? items.filter(i => !i.bought) : items;
                return filtered.reduce((acc, item) => {
                    const cat = item.category || "Altro";
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(item);
                    return acc;
                }, {});
            }, [items, hideBought]);

            const areAllCollapsed = useMemo(() => {
                const keys = Object.keys(groupedItems);
                if (keys.length === 0) return false;
                return keys.every(k => collapsedCats[k] === true);
            }, [collapsedCats, groupedItems]);
            
            const toggleGlobalCollapse = () => {
                const newState = !areAllCollapsed;
                const newObj = {};
                Object.keys(groupedItems).forEach(c => {
                    newObj[c] = newState;
                });
                setCollapsedCats(newObj);
            };

            const clearBoughtItems = () => {
                setItems(prev => prev.filter(i => !i.bought));
            };

            return (
                <div className="max-w-md mx-auto min-h-screen px-4 pt-6 main-container">
                    {/* Header Azioni */}
                    <div className="flex justify-between items-center mb-6">
                        {/* Logo + titolo */}
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-md">
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="white">
                                    <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                                </svg>
                            </div>
                            <h1 className="text-lg font-black text-slate-800 italic uppercase">
                                Chef Spesa
                            </h1>
                        </div>

                        {/* Pulsanti azioni */}
                        <div className="flex items-center bg-white p-1 rounded-xl border border-slate-200 shadow-sm gap-0.5">
                            {/* Nascondi/mostra presi */}
                            <button
                                onClick={() => setHideBought(!hideBought)}
                                className="has-tooltip p-2 text-slate-400 hover:text-blue-600 active:scale-90 transition-all"
                            >
                                {hideBought ? (
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5">
                                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                        <line x1="1" y1="1" x2="23" y2="23"/>
                                    </svg>
                                ) : (
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                )}
                                <span className="tooltip">
                                    {hideBought ? 'Mostra presi' : 'Nascondi presi'}
                                </span>
                            </button>

                            {/* Collassa/espandi categorie */}
                            <button
                                onClick={toggleGlobalCollapse}
                                className="has-tooltip p-2 text-slate-400 hover:text-slate-600 active:scale-90 transition-all"
                            >
                                {areAllCollapsed ? (
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5">
                                        <polyline points="7 13 12 18 17 13"/>
                                        <polyline points="7 6 12 11 17 6"/>
                                    </svg>
                                ) : (
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5">
                                        <polyline points="17 11 12 6 7 11"/>
                                        <polyline points="17 18 12 13 7 18"/>
                                    </svg>
                                )}
                                <span className="tooltip">
                                    {areAllCollapsed ? 'Espandi tutti' : 'Riduci tutti'}
                                </span>
                            </button>

                            <div className="w-[1px] h-4 bg-slate-200 mx-1"></div>

                            {/* Pulisci solo presi */}
                            <button
                                onClick={() => setShowConfirmClearBought(true)}
                                className="has-tooltip p-2 text-slate-400 hover:text-orange-500 active:scale-90 transition-all"
                            >
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5">
                                    <path d="M20 6L9 17l-5-5"/>
                                    <path d="M3 6h18" opacity="0.3"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" opacity="0.3"/>
                                </svg>
                                <span className="tooltip">Pulisci presi</span>
                            </button>

                            {/* Svuota lista */}
                            <button
                                onClick={() => setShowConfirmReset(true)}
                                className="has-tooltip p-2 text-slate-400 hover:text-red-500 active:scale-90 transition-all"
                            >
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                                <span className="tooltip">Svuota lista</span>
                            </button>

                            <div className="w-[1px] h-4 bg-slate-200 mx-1"></div>

                            {/* Cronologia */}
                            <button
                                onClick={() => setShowHistory(true)}
                                className="has-tooltip p-2 text-slate-400 hover:text-slate-600 active:scale-90 transition-all"
                            >
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <span className="tooltip">Cronologia</span>
                            </button>

                            {/* Impostazioni */}
                            <button
                                onClick={() => setShowSettings(true)}
                                className="has-tooltip p-2 text-slate-400 hover:text-slate-600 active:scale-90 transition-all"
                            >
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                </svg>
                                <span className="tooltip">Impostazioni</span>
                            </button>
                        </div>
                    </div>

                    {/* Liste per categoria */}
                    <div className="space-y-4">
                        {Object.entries(groupedItems).sort().map(([cat, list]) => (
                            <div key={cat} className="mb-2">
                                {/* Header categoria + freccia collapse */}
                                <button
                                    type="button"
                                    onClick={() =>
                                        setCollapsedCats(prev => ({ ...prev, [cat]: !prev[cat] }))
                                    }
                                    className="w-full flex items-center justify-between mb-1.5 px-1"
                                >
                                    <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                        {cat} • {list.length}
                                    </span>
                                    <span className="text-slate-400">
                                        {collapsedCats[cat] ? (
                                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2.5">
                                                <polyline points="7 13 12 18 17 13"/>
                                            </svg>
                                        ) : (
                                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2.5">
                                                <polyline points="17 11 12 6 7 11"/>
                                            </svg>
                                        )}
                                    </span>
                                </button>

                                {/* Lista articoli */}
                                {!collapsedCats[cat] && (
                                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden divide-y divide-slate-50">
                                        {list.map(item => (
                                            <div
                                                key={item.id}
                                                className="flex items-center p-3.5"
                                                onClick={() =>
                                                    setItems(items.map(i => i.id === item.id ? { ...i, bought: !i.bought } : i))
                                                }
                                            >
                                                <div
                                                    className={`w-5 h-5 rounded-lg border-2 flex items-center justify-center mr-3 ${
                                                        item.bought ? 'bg-green-500 border-green-500' : 'border-slate-200'
                                                    }`}
                                                >
                                                    {item.bought && (
                                                        <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="white" strokeWidth="4">
                                                            <polyline points="20 6 9 17 4 12"/>
                                                        </svg>
                                                    )}
                                                </div>

                                                <span
                                                    className={`flex-1 text-sm font-bold ${
                                                        item.bought ? 'line-through text-slate-300 italic' : 'text-slate-700'
                                                    }`}
                                                >
                                                    {item.name}
                                                </span>

                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setItems(items.filter(i => i.id !== item.id));
                                                    }}
                                                    className="text-slate-200 hover:text-red-400 p-1"
                                                >
                                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5">
                                                        <line x1="18" y1="6" x2="6" y2="18"/>
                                                        <line x1="6" y1="6" x2="18" y2="18"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* Barra input in basso */}
                    <div className="fixed bottom-0 left-0 right-0 p-4 pb-8 bg-gradient-to-t from-slate-100 via-slate-100/90 to-transparent">
                        <div className="max-w-md mx-auto relative">
                            {isLoading && (
                                <div className="absolute -top-12 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-full flex items-center gap-2 shadow-xl">
                                    <div className="mini-loader"></div>
                                    <span className="text-[10px] font-black uppercase">IA...</span>
                                </div>
                            )}
                            <div className="bg-white rounded-[2rem] shadow-2xl border border-slate-200 p-2 flex items-end gap-2">
                                <textarea
                                    value={textInput}
                                    onChange={(e) => setTextInput(e.target.value)}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter' && !e.shiftKey) {
                                            e.preventDefault();
                                            processWithAI(textInput);
                                        }
                                    }}
                                    placeholder="Cosa serve?"
                                    className="flex-1 bg-transparent py-4 ml-4 text-sm font-bold focus:outline-none resize-none"
                                    rows="1"
                                />
                                <button
                                    onClick={() => {
                                        if (!recognitionRef.current) return;
                                        if (isRecording) {
                                            recognitionRef.current.stop();
                                        } else {
                                            recognitionRef.current.start();
                                            setIsRecording(true);
                                        }
                                    }}
                                    className={`w-10 h-10 rounded-full flex items-center justify-center ${
                                        isRecording ? 'bg-red-500 text-white' : 'bg-slate-100 text-slate-400'
                                    }`}
                                >
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5">
                                        <path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 0 0-6 0v4a3 3 0 0 0 3 3z"/>
                                        <path d="M19 11a7 7 0 0 1-14 0"/>
                                        <line x1="12" y1="18" x2="12" y2="22"/>
                                        <line x1="8" y1="22" x2="16" y2="22"/>
                                    </svg>
                                </button>
                                <button
                                    onClick={() => processWithAI(textInput)}
                                    disabled={!textInput.trim() || isLoading}
                                    className="w-14 h-14 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg active:scale-95 disabled:opacity-50"
                                >
                                    <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" strokeWidth="3">
                                        <line x1="22" y1="2" x2="11" y2="13"/>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Modale impostazioni */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-50 flex items-center justify-center p-6">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-sm p-8 shadow-2xl">
                                <h3 className="text-xl font-black text-slate-800 mb-8 text-center uppercase italic">
                                    Configurazione
                                </h3>
                                <div className="space-y-4 mb-10">
                                    
                                    {/* IA Attiva */}
                                    <div className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                                        <span className="text-[10px] font-black uppercase">IA Attiva</span>
                                        <label className="toggle-switch">
                                            <input
                                                type="checkbox"
                                                checked={aiEnabled}
                                                onChange={() => setAiEnabled(!aiEnabled)}
                                            />
                                            <span className="slider"></span>
                                        </label>
                                    </div>

                                    {/* API KEY */}

                                    <div>
                                       {/* <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block ml-1">
                                            Gemini API Key
                                        </label>*/}
                                        <input
                                            type="password"
                                            id="key_field"
                                            defaultValue={apiKey}
                                            placeholder="Gemini API Key..."
                                            className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 text-sm font-bold focus:border-blue-500 outline-none"
                                        />
                                    </div>

                                    
                                    {/* Mostra Ricette (solo se IA attiva) */}

                                      <div className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                        <span className="text-[10px] font-black text-slate-700 uppercase tracking-tight">
                                          Mostra Ricette
                                        </span>
                                        <label className="toggle-switch">
                                            <input
                                              type="checkbox"
                                              checked={aiEnabled && showSocial}   // se IA off → sempre false
                                              onChange={() => setShowSocial(!showSocial)}
                                              disabled={!aiEnabled}
                                            />
                                          <span className="slider"></span>
                                        </label>
                                      </div>


                                    {/* Auto-Salvataggio */}
                                    <div className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                        <span className="text-[10px] font-black text-slate-700 uppercase tracking-tight">
                                            Auto-Salvataggio
                                        </span>
                                        <label className="toggle-switch">
                                            <input
                                                type="checkbox"
                                                checked={autoSave}
                                                onChange={() => setAutoSave(!autoSave)}
                                            />
                                            <span className="slider"></span>
                                        </label>
                                    </div>




                                    {/* Help */}
                                    <div className="flex flex-col gap-3 mt-4">
                                        <button
                                            onClick={() => {
                                                window.location.href = 'help.html';
                                            }}
                                            className="w-full bg-slate-100 text-slate-700 rounded-2xl py-3 text-[11px] font-black uppercase tracking-widest"
                                        >
                                            Guida / Help
                                        </button>
                                    </div>
                                </div>
                                <button
                                    onClick={() => {
                                        const val = document.getElementById('key_field').value.trim();
                                        setApiKey(val);
                                        localStorage.setItem('chef_api_key', val);
                                        setShowSettings(false);
                                    }}
                                    className="w-full bg-blue-600 text-white rounded-2xl py-4 text-xs font-black uppercase tracking-widest shadow-lg shadow-blue-200"
                                >
                                    Salva e Chiudi
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Wizard categoria manuale */}
                    {categoryWizardOpen && (
                        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[80] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-xs p-8 shadow-2xl text-center">
                                <h3 className="text-lg font-black uppercase mb-4">Categoria</h3>
                                <p className="text-sm font-black text-blue-600 mb-6 uppercase">
                                    "{pendingCategoryItems[currentPendingIndex]}"
                                </p>
                                <div className="grid grid-cols-2 gap-2 mb-6 max-h-60 overflow-y-auto pr-1">
                                    {CATEGORY_OPTIONS.map(cat => (
                                        <button
                                            key={cat}
                                            onClick={() => addPendingItemWithCategory(cat)}
                                            className="px-3 py-2 text-[10px] font-black uppercase rounded-xl bg-slate-50 border border-slate-100"
                                        >
                                            {cat}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Conferma svuota lista */}
                    {showConfirmReset && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[60] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-xs p-8 text-center shadow-2xl">
                                <h3 className="text-xl font-black mb-2 uppercase">Svuota?</h3>
                                <div className="flex flex-col gap-3 mt-8">
                                    <button
                                        onClick={() => {
                                            setItems([]);
                                            setShowConfirmReset(false);
                                        }}
                                        className="bg-red-500 text-white rounded-2xl py-4 font-black uppercase text-xs"
                                    >
                                        Svuota
                                    </button>
                                    <button
                                        onClick={() => setShowConfirmReset(false)}
                                        className="bg-slate-100 text-slate-500 rounded-2xl py-4 font-black uppercase text-xs"
                                    >
                                        Annulla
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Conferma pulisci presi */}
                    {showConfirmClearBought && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[70] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-xs p-8 text-center shadow-2xl">
                                <h3 className="text-xl font-black mb-2 uppercase">Rimuovere i presi?</h3>
                                <p className="text-[11px] text-slate-500 font-bold uppercase mb-6">
                                    Verranno eliminati solo gli articoli segnati come acquistati.
                                </p>
                                <div className="flex flex-col gap-3">
                                    <button
                                        onClick={() => {
                                            clearBoughtItems();
                                            setShowConfirmClearBought(false);
                                        }}
                                        className="bg-orange-500 text-white rounded-2xl py-4 font-black uppercase text-xs"
                                    >
                                        Pulisci presi
                                    </button>
                                    <button
                                        onClick={() => setShowConfirmClearBought(false)}
                                        className="bg-slate-100 text-slate-500 rounded-2xl py-4 font-black uppercase text-xs"
                                    >
                                        Annulla
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Cronologia */}
                    {showHistory && (
                        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[65] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-sm p-8 shadow-2xl flex flex-col max-h-[70vh]">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-black uppercase">Cronologia</h3>
                                    <button
                                        onClick={() => setShowHistory(false)}
                                        className="text-slate-300 hover:text-slate-500"
                                    >
                                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5">
                                            <line x1="18" y1="6" x2="6" y2="18"/>
                                            <line x1="6" y1="6" x2="18" y2="18"/>
                                        </svg>
                                    </button>
                                </div>
                                <div className="flex-1 overflow-y-auto pr-1 space-y-2">
                                    {history.length === 0 && (
                                        <p className="text-[11px] text-slate-400 font-bold uppercase text-center">
                                            Nessuna richiesta ancora.
                                        </p>
                                    )}
                                    {history.map(entry => (
                                        <div
                                            key={entry.id}
                                            className="px-4 py-3 rounded-2xl bg-slate-50 border border-slate-100 text-xs font-bold text-slate-700"
                                        >
                                            <div className="text-[10px] text-slate-400 uppercase mb-1">
                                                {new Date(entry.ts).toLocaleString('it-IT')}
                                            </div>
                                            {entry.text}
                                        </div>
                                    ))}
                                </div>
                                {history.length > 0 && (
                                    <button
                                        onClick={() => setHistory([])}
                                        className="mt-4 w-full bg-slate-900 text-white rounded-2xl py-3 text-[11px] font-black uppercase"
                                    >
                                        Svuota cronologia
                                    </button>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Modale errore */}
                    {errorModal.show && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-xs p-8 text-center error-shake shadow-2xl">
                                <h3 className="text-xl font-black mb-2 uppercase italic">{errorModal.title}</h3>
                                <p className="text-slate-500 text-[11px] font-bold mb-8 uppercase">
                                    {errorModal.message}
                                </p>
                                <button
                                    onClick={() => setErrorModal({ show: false, title: '', message: '' })}
                                    className="w-full bg-slate-800 text-white rounded-2xl py-4 text-xs font-black uppercase"
                                >
                                    OK
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
